---
// src/layouts/Layout.astro
import '../styles/global.css';
import 'lenis/dist/lenis.css';
import Footer from '../Components/Footer.astro';
import Navbar from '../Components/Navbar.astro';
import Preloader from '../Components/Ui/Preloader.astro';
import BackToTop from '../Components/Ui/BackToTop.astro';
import Analytics from '../Components/Ui/Analytics.astro';

interface Props {
	title: string;
	description?: string;
	showPreloader?: boolean;
	// NOTE: use explicit prop names to avoid any edge-case with reserved/ambiguous attribute names.
	canonicalHref?: string;
	robotsMeta?: string;
	// Back-compat aliases (in case some pages already use these names)
	canonical?: string;
	robots?: string;
}

const { 
	title = "NOVATERRA | Earth Engineering", 
	description = "Ingegneria del territorio e scavi in Toscana.",
	showPreloader = false,
	canonicalHref,
	robotsMeta,
	canonical,
	robots,
} = Astro.props;

---

<!doctype html>
<html lang="it">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<title>{title}</title>
		<meta name="description" content={description} />
		{(canonicalHref ?? canonical) && <link rel="canonical" href={(canonicalHref ?? canonical)!} />}
		{(robotsMeta ?? robots) && <meta name="robots" content={(robotsMeta ?? robots)!} />}
		<Analytics />
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	</head>
	<body class="bg-nova-bg text-nova-text font-sans antialiased overflow-x-hidden selection:bg-nova-accent selection:text-white">
		
		{showPreloader && <Preloader />}
		<Navbar />

		<div class="noise-overlay fixed inset-0 pointer-events-none z-[9999] opacity-[0.03]"></div>
		<div class="cursor-cross"></div>

		<main id="main-content">
			<slot />
		</main>
		
		<BackToTop />
		
		<Footer />

		<!-- Ensure hero reveals start right after the preloader ends, even if the main site script fails -->
		<script is:inline>
			(() => {
				const html = document.documentElement;
				const preloader = document.getElementById('preloader');

				// No preloader on this page -> ready immediately
				if (!preloader) {
					html.classList.add('site-ready');
					return;
				}

				// If already hidden (e.g. cached navigation), mark ready immediately
				if (preloader.classList.contains('hidden')) {
					html.classList.add('site-ready');
					return;
				}

				// Sync with preloader timing (3.5s) + a tiny buffer for the fade-out
				window.setTimeout(() => {
					html.classList.add('site-ready');
				}, 3600);
			})();
		</script>
<!-- Bundle site script via Astro/Vite (DO NOT inline). This generates a real /_astro/*.js asset. -->
<script>
	import "../scripts/site.ts";
</script>

<style is:global>
			.noise-overlay {
				background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
			}
		</style>
	</body>
</html>
